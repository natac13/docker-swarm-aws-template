{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Docker Swarm setup.",
  "Conditions": {
    "CreateLogResources": {
      "Fn::Equals": [
        {
          "Ref": "EnableCloudWatchLogs"
        },
        "yes"
      ]
    },
    "HasOnly2AZs": {
      "Fn::Equals": [
        {
          "Fn::FindInMap": [
            "AWSRegion2AZ",
            {
              "Ref": "AWS::Region"
            },
            "NumAZs"
          ]
        },
        "2"
      ]
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Swarm Size"
          },
          "Parameters": ["ManagerSize", "ClusterSize"]
        },
        {
          "Label": {
            "default": "Swarm Properties"
          },
          "Parameters": ["KeyName", "EnableCloudWatchLogs"]
        },
        {
          "Label": {
            "default": "Swarm Manager Properties"
          },
          "Parameters": [
            "ManagerInstanceType",
            "ManagerDiskSize",
            "ManagerDiskType"
          ]
        },
        {
          "Label": {
            "default": "Swarm Worker Properties"
          },
          "Parameters": [
            "WorkerInstanceType",
            "WorkerDiskSize",
            "WorkerDiskType"
          ]
        }
      ],
      "ParameterLabels": {
        "ClusterSize": {
          "default": "Number of Swarm worker nodes?"
        },
        "EnableCloudWatchLogs": {
          "default": "Use Cloudwatch for container logging?"
        },
        "EnableSystemPrune": {
          "default": "Enable daily resource cleanup?"
        },
        "WorkerInstanceType": {
          "default": "Agent worker instance type?"
        },
        "KeyName": {
          "default": "Which SSH key to use?"
        },
        "ManagerDiskSize": {
          "default": "Manager ephemeral storage volume size?"
        },
        "ManagerDiskType": {
          "default": "Manager ephemeral storage volume type"
        },
        "ManagerInstanceType": {
          "default": "Swarm manager instance type?"
        },
        "ManagerSize": {
          "default": "Number of Swarm managers?"
        },
        "WorkerDiskSize": {
          "default": "Worker ephemeral storage volume size?"
        },
        "WorkerDiskType": {
          "default": "Worker ephemeral storage volume type"
        }
      }
    },
    "AWS::CloudFormation::Designer": {
      "0b630a3e-8b47-4876-bc52-7b0c367e0c8f": {
        "size": {
          "width": 1040,
          "height": 1000
        },
        "position": {
          "x": 430,
          "y": 80
        },
        "z": 0,
        "embeds": [
          "d780bac1-56c2-425e-a534-a3f55f40e397",
          "5ddc92d7-fa7c-41d4-a827-625da8863891",
          "bc22286e-07bb-426e-8429-46c6227ec606",
          "1bd90a7c-409f-4ae2-a8ea-884184de0a15",
          "ff48ecc5-209e-49a4-9e81-602253cc6e8e",
          "b5b0775b-3d32-40f8-a6bf-c2b0455895d6",
          "829c36b5-fc86-4dc7-8cf1-9a9c84bd5151",
          "7d748840-94c2-409e-a76b-e68d416e46bf",
          "06906175-e554-4768-8cb5-547401eceadd",
          "5bc5d03a-a523-4c79-a0da-a84c6f65ed7d",
          "117d008d-7b69-4c5c-9fbd-fc3893e18896",
          "625bcd3e-aad4-4185-9d38-eaaa609b01f2"
        ]
      },
      "7d748840-94c2-409e-a76b-e68d416e46bf": {
        "size": {
          "width": 340,
          "height": 200
        },
        "position": {
          "x": 460,
          "y": 130
        },
        "z": 1,
        "parent": "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
        "embeds": [],
        "dependson": ["0b630a3e-8b47-4876-bc52-7b0c367e0c8f"]
      },
      "e5d473f6-1ff8-4f9b-89e6-723978b05dda": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": -90,
          "y": 490
        },
        "z": 0,
        "embeds": [],
        "dependson": ["0b630a3e-8b47-4876-bc52-7b0c367e0c8f"]
      },
      "e9c77833-dd43-47ab-86c9-e99c6a6cd34a": {
        "source": {
          "id": "0b630a3e-8b47-4876-bc52-7b0c367e0c8f"
        },
        "target": {
          "id": "e5d473f6-1ff8-4f9b-89e6-723978b05dda"
        },
        "z": 0
      },
      "ff48ecc5-209e-49a4-9e81-602253cc6e8e": {
        "size": {
          "width": 330,
          "height": 180
        },
        "position": {
          "x": 860,
          "y": 390
        },
        "z": 1,
        "parent": "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
        "embeds": ["7ac1f66d-0463-4b9c-a840-6cdb8a562d7a"],
        "dependson": ["0b630a3e-8b47-4876-bc52-7b0c367e0c8f"]
      },
      "7ac1f66d-0463-4b9c-a840-6cdb8a562d7a": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 880,
          "y": 440
        },
        "z": 2,
        "parent": "ff48ecc5-209e-49a4-9e81-602253cc6e8e",
        "embeds": [],
        "isassociatedwith": ["e5d473f6-1ff8-4f9b-89e6-723978b05dda"],
        "dependson": [
          "e9c77833-dd43-47ab-86c9-e99c6a6cd34a",
          "ff48ecc5-209e-49a4-9e81-602253cc6e8e",
          "e5d473f6-1ff8-4f9b-89e6-723978b05dda"
        ]
      },
      "6d87f156-f7b4-4d24-82bb-824b67d056c9": {
        "source": {
          "id": "ff48ecc5-209e-49a4-9e81-602253cc6e8e"
        },
        "target": {
          "id": "7d748840-94c2-409e-a76b-e68d416e46bf"
        },
        "z": 1
      },
      "bc22286e-07bb-426e-8429-46c6227ec606": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1370,
          "y": 520
        },
        "z": 1,
        "parent": "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
        "embeds": [],
        "iscontainedinside": [
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f"
        ]
      },
      "829c36b5-fc86-4dc7-8cf1-9a9c84bd5151": {
        "size": {
          "width": 320,
          "height": 190
        },
        "position": {
          "x": 870,
          "y": 140
        },
        "z": 1,
        "parent": "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
        "embeds": [],
        "dependson": ["0b630a3e-8b47-4876-bc52-7b0c367e0c8f"]
      },
      "b5b0775b-3d32-40f8-a6bf-c2b0455895d6": {
        "size": {
          "width": 340,
          "height": 180
        },
        "position": {
          "x": 460,
          "y": 390
        },
        "z": 1,
        "parent": "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
        "embeds": [],
        "dependson": ["0b630a3e-8b47-4876-bc52-7b0c367e0c8f"]
      },
      "1bd90a7c-409f-4ae2-a8ea-884184de0a15": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1370,
          "y": 830
        },
        "z": 1,
        "parent": "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
        "embeds": [],
        "dependson": ["0b630a3e-8b47-4876-bc52-7b0c367e0c8f"]
      },
      "5bc5d03a-a523-4c79-a0da-a84c6f65ed7d": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1370,
          "y": 630
        },
        "z": 1,
        "parent": "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
        "embeds": [],
        "iscontainedinside": [
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f"
        ]
      },
      "06906175-e554-4768-8cb5-547401eceadd": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1370,
          "y": 730
        },
        "z": 1,
        "parent": "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
        "embeds": [],
        "dependson": ["0b630a3e-8b47-4876-bc52-7b0c367e0c8f"]
      },
      "6e6d3b3c-624a-4849-a78c-f9f28a5e0b74": {
        "source": {
          "id": "ff48ecc5-209e-49a4-9e81-602253cc6e8e"
        },
        "target": {
          "id": "829c36b5-fc86-4dc7-8cf1-9a9c84bd5151"
        },
        "z": 1
      },
      "cd0e7912-d672-4611-8b90-2a84250ccb3e": {
        "source": {
          "id": "ff48ecc5-209e-49a4-9e81-602253cc6e8e"
        },
        "target": {
          "id": "b5b0775b-3d32-40f8-a6bf-c2b0455895d6"
        },
        "z": 1
      },
      "28272b0f-5582-4714-81c8-5358e0f9e2b3": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 340,
          "y": 620
        },
        "z": 0,
        "embeds": [],
        "isassociatedwith": ["5ddc92d7-fa7c-41d4-a827-625da8863891"]
      },
      "625bcd3e-aad4-4185-9d38-eaaa609b01f2": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 950,
          "y": 890
        },
        "z": 1,
        "parent": "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
        "embeds": [],
        "dependson": ["be37df0b-c7dd-47c1-8dcf-ff93660fe32f"]
      },
      "5ddc92d7-fa7c-41d4-a827-625da8863891": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 950,
          "y": 990
        },
        "z": 1,
        "parent": "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
        "embeds": [],
        "iscontainedinside": [
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f"
        ]
      },
      "117d008d-7b69-4c5c-9fbd-fc3893e18896": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 820,
          "y": 980
        },
        "z": 1,
        "parent": "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
        "embeds": [],
        "dependson": ["be37df0b-c7dd-47c1-8dcf-ff93660fe32f"]
      },
      "be37df0b-c7dd-47c1-8dcf-ff93660fe32f": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 110,
          "y": 620
        },
        "z": 0,
        "embeds": [],
        "dependson": [
          "7d748840-94c2-409e-a76b-e68d416e46bf",
          "b5b0775b-3d32-40f8-a6bf-c2b0455895d6",
          "829c36b5-fc86-4dc7-8cf1-9a9c84bd5151",
          "d780bac1-56c2-425e-a534-a3f55f40e397",
          "e9c77833-dd43-47ab-86c9-e99c6a6cd34a"
        ]
      },
      "d780bac1-56c2-425e-a534-a3f55f40e397": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1360,
          "y": 950
        },
        "z": 1,
        "parent": "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
        "embeds": [],
        "iscontainedinside": [
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f",
          "0b630a3e-8b47-4876-bc52-7b0c367e0c8f"
        ]
      },
      "dcb2f295-39a2-4ba8-a907-1eb5249b915f": {
        "source": {
          "id": "7ac1f66d-0463-4b9c-a840-6cdb8a562d7a"
        },
        "target": {
          "id": "e5d473f6-1ff8-4f9b-89e6-723978b05dda"
        },
        "z": 11
      }
    }
  },
  "Parameters": {
    "ManagerInstanceType": {
      "Description": "Docker Swarm Manager EC2 instance type",
      "Type": "String",
      "Default": "t2.micro",
      "AllowedValues": [
        "t1.micro",
        "t2.nano",
        "t2.micro",
        "t2.small",
        "t2.medium",
        "t2.large",
        "t3.nano",
        "t3.micro",
        "t3.small",
        "t3.medium",
        "t3.large",
        "t3.xlarge",
        "t3.2xlarge",
        "t3a.nano",
        "t3a.micro",
        "t3a.small",
        "t3a.medium",
        "t3a.large",
        "t3a.xlarge",
        "t3a.2xlarge",
        "m1.small",
        "m1.medium",
        "m1.large",
        "m1.xlarge",
        "m2.xlarge",
        "m2.2xlarge",
        "m2.4xlarge",
        "m3.medium",
        "m3.large",
        "m3.xlarge",
        "m3.2xlarge",
        "m4.large",
        "m4.xlarge",
        "m4.2xlarge",
        "m4.4xlarge",
        "m4.10xlarge",
        "c1.medium",
        "c1.xlarge",
        "c3.large",
        "c3.xlarge",
        "c3.2xlarge",
        "c3.4xlarge",
        "c3.8xlarge",
        "c4.large",
        "c4.xlarge",
        "c4.2xlarge",
        "c4.4xlarge",
        "c4.8xlarge",
        "g2.2xlarge",
        "g2.8xlarge",
        "r3.large",
        "r3.xlarge",
        "r3.2xlarge",
        "r3.4xlarge",
        "r3.8xlarge",
        "i2.xlarge",
        "i2.2xlarge",
        "i2.4xlarge",
        "i2.8xlarge",
        "d2.xlarge",
        "d2.2xlarge",
        "d2.4xlarge",
        "d2.8xlarge",
        "hi1.4xlarge",
        "hs1.8xlarge",
        "cr1.8xlarge",
        "cc2.8xlarge",
        "cg1.4xlarge"
      ],
      "ConstraintDescription": "must be a valid EC2 instance type."
    },
    "WorkerInstanceType": {
      "Description": "Docker Swarm Worker EC2 instance type",
      "Type": "String",
      "Default": "t2.micro",
      "AllowedValues": [
        "t1.micro",
        "t2.nano",
        "t2.micro",
        "t2.small",
        "t2.medium",
        "t2.large",
        "t3.nano",
        "t3.micro",
        "t3.small",
        "t3.medium",
        "t3.large",
        "t3.xlarge",
        "t3.2xlarge",
        "t3a.nano",
        "t3a.micro",
        "t3a.small",
        "t3a.medium",
        "t3a.large",
        "t3a.xlarge",
        "t3a.2xlarge",
        "m1.small",
        "m1.medium",
        "m1.large",
        "m1.xlarge",
        "m2.xlarge",
        "m2.2xlarge",
        "m2.4xlarge",
        "m3.medium",
        "m3.large",
        "m3.xlarge",
        "m3.2xlarge",
        "m4.large",
        "m4.xlarge",
        "m4.2xlarge",
        "m4.4xlarge",
        "m4.10xlarge"
      ],
      "ConstraintDescription": "must be a valid EC2 instance type."
    },
    "KeyName": {
      "Description": "Name of an EC2 KeyPair to enable SSH access to the instance.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "must be the name of an existing EC2 KeyPair."
    },
    "SSHLocation": {
      "Description": " The IP address range that can be used to access the web server using SSH.",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "0.0.0.0/0",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
    },
    "ClusterSize": {
      "Default": "0",
      "Description": "Number of worker nodes in the Swarm (0-1000).",
      "MaxValue": "100",
      "MinValue": "0",
      "Type": "Number"
    },
    "EnableCloudWatchLogs": {
      "AllowedValues": ["no", "yes"],
      "Default": "yes",
      "Description": "Send all Container logs to CloudWatch",
      "Type": "String"
    },
    "EnableSystemPrune": {
      "AllowedValues": ["no", "yes"],
      "Default": "no",
      "Description": "Cleans up unused images, containers, networks and volumes",
      "Type": "String"
    },
    "ManagerDiskSize": {
      "Default": "20",
      "Description": "Size of Manager's ephemeral storage volume in GiB",
      "MaxValue": "1024",
      "MinValue": "20",
      "Type": "Number"
    },
    "ManagerSize": {
      "AllowedValues": ["1", "3", "5"],
      "Default": "1",
      "Description": "Number of Swarm manager nodes (1, 3, 5)",
      "Type": "Number"
    },
    "WorkerDiskSize": {
      "Default": "20",
      "Description": "Size of Workers's ephemeral storage volume in GiB",
      "MaxValue": "1024",
      "MinValue": "20",
      "Type": "Number"
    }
  },
  "Mappings": {
    "AWSInstanceType2Arch": {
      "t1.micro": {
        "Arch": "HVM64"
      },
      "t2.nano": {
        "Arch": "HVM64"
      },
      "t2.micro": {
        "Arch": "HVM64"
      },
      "t2.small": {
        "Arch": "HVM64"
      },
      "t2.medium": {
        "Arch": "HVM64"
      },
      "t2.large": {
        "Arch": "HVM64"
      },
      "t3a.nano": {
        "Arch": "HVM64"
      },
      "t3.micro": {
        "Arch": "HVM64"
      },
      "t3.small": {
        "Arch": "HVM64"
      },
      "t3.medium": {
        "Arch": "HVM64"
      },
      "t3.large": {
        "Arch": "HVM64"
      },
      "t3.xlarge": {
        "Arch": "HVM64"
      },
      "t3.2xlarge": {
        "Arch": "HVM64"
      },
      "t3a.micro": {
        "Arch": "HVM64"
      },
      "t3a.small": {
        "Arch": "HVM64"
      },
      "t3a.medium": {
        "Arch": "HVM64"
      },
      "t3a.large": {
        "Arch": "HVM64"
      },
      "t3a.xlarge": {
        "Arch": "HVM64"
      },
      "t3a.2xlarge": {
        "Arch": "HVM64"
      },
      "m1.small": {
        "Arch": "HVM64"
      },
      "m1.medium": {
        "Arch": "HVM64"
      },
      "m1.large": {
        "Arch": "HVM64"
      },
      "m1.xlarge": {
        "Arch": "HVM64"
      },
      "m2.xlarge": {
        "Arch": "HVM64"
      },
      "m2.2xlarge": {
        "Arch": "HVM64"
      },
      "m2.4xlarge": {
        "Arch": "HVM64"
      },
      "m3.medium": {
        "Arch": "HVM64"
      },
      "m3.large": {
        "Arch": "HVM64"
      },
      "m3.xlarge": {
        "Arch": "HVM64"
      },
      "m3.2xlarge": {
        "Arch": "HVM64"
      },
      "m4.large": {
        "Arch": "HVM64"
      },
      "m4.xlarge": {
        "Arch": "HVM64"
      },
      "m4.2xlarge": {
        "Arch": "HVM64"
      },
      "m4.4xlarge": {
        "Arch": "HVM64"
      },
      "m4.10xlarge": {
        "Arch": "HVM64"
      }
    },
    "AWSRegion2AZ": {
      "ap-northeast-1": {
        "AZ0": "0",
        "AZ1": "1",
        "AZ2": "0",
        "EFSSupport": "no",
        "LambdaSupport": "yes",
        "Name": "Tokyo",
        "NumAZs": "2"
      },
      "ap-northeast-2": {
        "AZ0": "0",
        "AZ1": "1",
        "AZ2": "0",
        "EFSSupport": "no",
        "LambdaSupport": "yes",
        "Name": "Seoul",
        "NumAZs": "2"
      },
      "ap-south-1": {
        "AZ0": "0",
        "AZ1": "1",
        "AZ2": "0",
        "EFSSupport": "no",
        "LambdaSupport": "yes",
        "Name": "Mumbai",
        "NumAZs": "2"
      },
      "ap-southeast-1": {
        "AZ0": "0",
        "AZ1": "1",
        "AZ2": "0",
        "EFSSupport": "no",
        "LambdaSupport": "yes",
        "Name": "Singapore",
        "NumAZs": "2"
      },
      "ap-southeast-2": {
        "AZ0": "0",
        "AZ1": "1",
        "AZ2": "2",
        "EFSSupport": "yes",
        "LambdaSupport": "yes",
        "Name": "Sydney",
        "NumAZs": "3"
      },
      "ca-central-1": {
        "AZ0": "0",
        "AZ1": "1",
        "AZ2": "0",
        "EFSSupport": "no",
        "LambdaSupport": "no",
        "Name": "Central",
        "NumAZs": "2"
      },
      "eu-central-1": {
        "AZ0": "0",
        "AZ1": "1",
        "AZ2": "2",
        "EFSSupport": "yes",
        "LambdaSupport": "yes",
        "Name": "Frankfurt",
        "NumAZs": "3"
      },
      "eu-west-1": {
        "AZ0": "0",
        "AZ1": "1",
        "AZ2": "2",
        "EFSSupport": "yes",
        "LambdaSupport": "yes",
        "Name": "Ireland",
        "NumAZs": "3"
      },
      "eu-west-2": {
        "AZ0": "0",
        "AZ1": "1",
        "AZ2": "0",
        "EFSSupport": "no",
        "LambdaSupport": "yes",
        "Name": "London",
        "NumAZs": "2"
      },
      "sa-east-1": {
        "AZ0": "0",
        "AZ1": "1",
        "AZ2": "0",
        "EFSSupport": "no",
        "LambdaSupport": "no",
        "Name": "Sao Paulo",
        "NumAZs": "2"
      },
      "us-east-1": {
        "AZ0": "0",
        "AZ1": "1",
        "AZ2": "2",
        "EFSSupport": "yes",
        "LambdaSupport": "yes",
        "Name": "N. Virgina",
        "NumAZs": "4"
      },
      "us-east-2": {
        "AZ0": "0",
        "AZ1": "1",
        "AZ2": "2",
        "EFSSupport": "yes",
        "LambdaSupport": "yes",
        "Name": "Ohio",
        "NumAZs": "3"
      },
      "us-gov-west-1": {
        "AZ0": "0",
        "AZ1": "1",
        "AZ2": "0",
        "EFSSupport": "no",
        "LambdaSupport": "no",
        "Name": "GovCloud",
        "NumAZs": "2"
      },
      "us-west-1": {
        "AZ0": "0",
        "AZ1": "1",
        "AZ2": "0",
        "EFSSupport": "no",
        "LambdaSupport": "yes",
        "Name": "N. California",
        "NumAZs": "2"
      },
      "us-west-2": {
        "AZ0": "0",
        "AZ1": "1",
        "AZ2": "2",
        "EFSSupport": "yes",
        "LambdaSupport": "yes",
        "Name": "Oregon",
        "NumAZs": "3"
      }
    },
    "AWSRegionArch2AMI": {
      "us-east-1": {
        "HVM64": "ami-04b9e92b5572fa0d1",
        "HVMG2": "NOT_SUPPORTED"
      },
      "us-east-2": {
        "HVM64": "ami-0a7f2b5b6b87eaa1b",
        "HVMG2": "NOT_SUPPORTED"
      },
      "us-west-2": {
        "HVM64": "ami-09c6723c6c24250c9",
        "HVMG2": "NOT_SUPPORTED"
      },
      "us-west-1": {
        "HVM64": "ami-00a3e4424e9ab3e56",
        "HVMG2": "NOT_SUPPORTED"
      },
      "eu-west-1": {
        "HVM64": "ami-0e41581acd7dedd99",
        "HVMG2": "NOT_SUPPORTED"
      },
      "eu-west-2": {
        "HVM64": "ami-00f94dc949fea2adf",
        "HVMG2": "NOT_SUPPORTED"
      },
      "eu-west-3": {
        "HVM64": "ami-0df03c7641cf41947",
        "HVMG2": "NOT_SUPPORTED"
      },
      "eu-central-1": {
        "HVM64": "ami-040a1551f9c9d11ad",
        "HVMG2": "NOT_SUPPORTED"
      },
      "ap-northeast-1": {
        "HVM64": "ami-0d5db3e2a1b98ca94",
        "HVMG2": "NOT_SUPPORTED"
      },
      "ap-northeast-2": {
        "HVM64": "ami-0f4362c71ffaf7759",
        "HVMG2": "NOT_SUPPORTED"
      },
      "ap-northeast-3": {
        "HVM64": "ami-07672d9af3947230d",
        "HVMG2": "NOT_SUPPORTED"
      },
      "ap-southeast-1": {
        "HVM64": "ami-0c199cae95cea87f0",
        "HVMG2": "NOT_SUPPORTED"
      },
      "ap-southeast-2": {
        "HVM64": "ami-0c0483bc96aef8b2f",
        "HVMG2": "NOT_SUPPORTED"
      },
      "ap-south-1": {
        "HVM64": "ami-0237472cf337d9529",
        "HVMG2": "NOT_SUPPORTED"
      },
      "ca-central-1": {
        "HVM64": "ami-0dbe45195223e250b",
        "HVMG2": "NOT_SUPPORTED"
      },
      "sa-east-1": {
        "HVM64": "ami-0065a65613972a22a",
        "HVMG2": "NOT_SUPPORTED"
      },
      "cn-north-1": {
        "HVM64": "ami-01993b4213b4bffb5",
        "HVMG2": "NOT_SUPPORTED"
      },
      "cn-northwest-1": {
        "HVM64": "ami-01d4e30d4d4952d0f",
        "HVMG2": "NOT_SUPPORTED"
      }
    },
    "VpcCidrs": {
      "pubsubnet1": {
        "cidr": "10.0.0.0/20"
      },
      "pubsubnet2": {
        "cidr": "10.0.16.0/20"
      },
      "pubsubnet3": {
        "cidr": "10.0.32.0/20"
      },
      "pubsubnet4": {
        "cidr": "10.0.48.0/20"
      },
      "vpc": {
        "cidr": "10.0.0.0/16"
      }
    },
    "DockerEnvironment": {
      "version": {
        "HasDDC": "no",
        "addOn": "base",
        "channel": "stable",
        "docker": "19.03.4-ce"
      }
    }
  },
  "Outputs": {
    "DefaultDNSTarget": {
      "Description": "Use this name to update your DNS records",
      "Value": {
        "Fn::GetAtt": ["ApplicationLoadBalancer", "DNSName"]
      }
    },
    "ManagerSecurityGroupID": {
      "Description": "SecurityGroup ID of ManagerVpcSG",
      "Value": {
        "Ref": "ManagerVpcSG"
      }
    },
    "Managers": {
      "Description": "You can see the manager nodes associated with this cluster here. Follow the instructions here: https://docs.docker.com/docker-for-aws/deploy/",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Ref": "AWS::Region"
            },
            ".console.aws.amazon.com/ec2/v2/home?region=",
            {
              "Ref": "AWS::Region"
            },
            "#Instances:tag:aws:autoscaling:groupName=",
            {
              "Ref": "ManagerAsg"
            },
            ";sort=desc:dnsName"
          ]
        ]
      }
    },
    "SwarmWideSecurityGroupID": {
      "Description": "SecurityGroup ID of SwarmWideSG",
      "Value": {
        "Ref": "SwarmWideSG"
      }
    },
    "VPCID": {
      "Description": "Use this as the VPC for configuring Private Hosted Zones",
      "Value": {
        "Ref": "Vpc"
      }
    },
    "ZoneAvailabilityComment": {
      "Description": "Availabilty Zones Comment",
      "Value": {
        "Fn::If": [
          "HasOnly2AZs",
          "This region only has 2 Availabiliy Zones (AZ). If one of those AZs goes away, it will cause problems for your Swarm Managers. Please use a Region with at least 3 AZs.",
          "This region has at least 3 Availability Zones (AZ). This is ideal to ensure a fully functional Swarm in case you lose an AZ."
        ]
      }
    }
  },
  "Resources": {
    "AttachGateway": {
      "DependsOn": ["Vpc", "InternetGateway"],
      "Properties": {
        "InternetGatewayId": {
          "Ref": "InternetGateway"
        },
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "e9c77833-dd43-47ab-86c9-e99c6a6cd34a"
        }
      }
    },
    "InternetGateway": {
      "DependsOn": "Vpc",
      "Properties": {
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "IGW"
                ]
              ]
            }
          }
        ]
      },
      "Type": "AWS::EC2::InternetGateway",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "e5d473f6-1ff8-4f9b-89e6-723978b05dda"
        }
      }
    },
    "ManagerVpcSG": {
      "DependsOn": "NodeVpcSG",
      "Properties": {
        "GroupDescription": "Manager SecurityGroup",
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "22",
            "IpProtocol": "tcp",
            "ToPort": "22"
          },
          {
            "IpProtocol": "50",
            "SourceSecurityGroupId": {
              "Fn::GetAtt": ["NodeVpcSG", "GroupId"]
            }
          },
          {
            "FromPort": "2377",
            "IpProtocol": "tcp",
            "SourceSecurityGroupId": {
              "Fn::GetAtt": ["NodeVpcSG", "GroupId"]
            },
            "ToPort": "2377"
          },
          {
            "FromPort": "4789",
            "IpProtocol": "udp",
            "SourceSecurityGroupId": {
              "Fn::GetAtt": ["NodeVpcSG", "GroupId"]
            },
            "ToPort": "4789"
          },
          {
            "FromPort": "7946",
            "IpProtocol": "tcp",
            "SourceSecurityGroupId": {
              "Fn::GetAtt": ["NodeVpcSG", "GroupId"]
            },
            "ToPort": "7946"
          },
          {
            "FromPort": "7946",
            "IpProtocol": "udp",
            "SourceSecurityGroupId": {
              "Fn::GetAtt": ["NodeVpcSG", "GroupId"]
            },
            "ToPort": "7946"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Type": "AWS::EC2::SecurityGroup",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "5bc5d03a-a523-4c79-a0da-a84c6f65ed7d"
        }
      }
    },
    "NodeVpcSG": {
      "DependsOn": "Vpc",
      "Properties": {
        "GroupDescription": "Node SecurityGroup",
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "8",
            "IpProtocol": "icmp",
            "ToPort": "0"
          },
          {
            "CidrIp": "0.0.0.0/0",
            "IpProtocol": "50"
          },
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "0",
            "IpProtocol": "udp",
            "ToPort": "65535"
          },
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "0",
            "IpProtocol": "tcp",
            "ToPort": "2374"
          },
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "2376",
            "IpProtocol": "tcp",
            "ToPort": "65535"
          }
        ],
        "SecurityGroupIngress": [
          {
            "CidrIp": {
              "Fn::FindInMap": ["VpcCidrs", "vpc", "cidr"]
            },
            "FromPort": "0",
            "IpProtocol": "-1",
            "ToPort": "65535"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Type": "AWS::EC2::SecurityGroup",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "06906175-e554-4768-8cb5-547401eceadd"
        }
      }
    },
    "PubSubnet1RouteTableAssociation": {
      "DependsOn": ["PubSubnetAz1", "RouteViaIgw"],
      "Properties": {
        "RouteTableId": {
          "Ref": "RouteViaIgw"
        },
        "SubnetId": {
          "Ref": "PubSubnetAz1"
        }
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "6d87f156-f7b4-4d24-82bb-824b67d056c9"
        }
      }
    },
    "PubSubnet2RouteTableAssociation": {
      "DependsOn": ["PubSubnetAz2", "RouteViaIgw"],
      "Properties": {
        "RouteTableId": {
          "Ref": "RouteViaIgw"
        },
        "SubnetId": {
          "Ref": "PubSubnetAz2"
        }
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "6e6d3b3c-624a-4849-a78c-f9f28a5e0b74"
        }
      }
    },
    "PubSubnet3RouteTableAssociation": {
      "DependsOn": ["PubSubnetAz3", "RouteViaIgw"],
      "Properties": {
        "RouteTableId": {
          "Ref": "RouteViaIgw"
        },
        "SubnetId": {
          "Ref": "PubSubnetAz3"
        }
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "cd0e7912-d672-4611-8b90-2a84250ccb3e"
        }
      }
    },
    "PubSubnetAz1": {
      "DependsOn": ["Vpc"],
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            {
              "Fn::FindInMap": [
                "AWSRegion2AZ",
                {
                  "Ref": "AWS::Region"
                },
                "AZ0"
              ]
            },
            {
              "Fn::GetAZs": {
                "Ref": "AWS::Region"
              }
            }
          ]
        },
        "CidrBlock": {
          "Fn::FindInMap": ["VpcCidrs", "pubsubnet1", "cidr"]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "Subnet1"
                ]
              ]
            }
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Type": "AWS::EC2::Subnet",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "7d748840-94c2-409e-a76b-e68d416e46bf"
        }
      }
    },
    "PubSubnetAz2": {
      "DependsOn": ["Vpc"],
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            {
              "Fn::FindInMap": [
                "AWSRegion2AZ",
                {
                  "Ref": "AWS::Region"
                },
                "AZ1"
              ]
            },
            {
              "Fn::GetAZs": {
                "Ref": "AWS::Region"
              }
            }
          ]
        },
        "CidrBlock": {
          "Fn::FindInMap": ["VpcCidrs", "pubsubnet2", "cidr"]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "Subnet2"
                ]
              ]
            }
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Type": "AWS::EC2::Subnet",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "829c36b5-fc86-4dc7-8cf1-9a9c84bd5151"
        }
      }
    },
    "PubSubnetAz3": {
      "DependsOn": ["Vpc"],
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            {
              "Fn::FindInMap": [
                "AWSRegion2AZ",
                {
                  "Ref": "AWS::Region"
                },
                "AZ2"
              ]
            },
            {
              "Fn::GetAZs": {
                "Ref": "AWS::Region"
              }
            }
          ]
        },
        "CidrBlock": {
          "Fn::FindInMap": ["VpcCidrs", "pubsubnet3", "cidr"]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "Subnet3"
                ]
              ]
            }
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Type": "AWS::EC2::Subnet",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "b5b0775b-3d32-40f8-a6bf-c2b0455895d6"
        }
      }
    },
    "PublicRouteViaIgw": {
      "DependsOn": ["AttachGateway", "RouteViaIgw", "InternetGateway"],
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "RouteTableId": {
          "Ref": "RouteViaIgw"
        },
        "GatewayId": {
          "Ref": "InternetGateway"
        }
      },
      "Type": "AWS::EC2::Route",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "7ac1f66d-0463-4b9c-a840-6cdb8a562d7a"
        }
      }
    },
    "RouteViaIgw": {
      "DependsOn": ["Vpc"],
      "Properties": {
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "RouteTable"
                ]
              ]
            }
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Type": "AWS::EC2::RouteTable",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "ff48ecc5-209e-49a4-9e81-602253cc6e8e"
        }
      }
    },
    "SwarmWideSG": {
      "DependsOn": "Vpc",
      "Properties": {
        "GroupDescription": "Swarm wide access",
        "SecurityGroupIngress": [
          {
            "CidrIp": {
              "Fn::FindInMap": ["VpcCidrs", "vpc", "cidr"]
            },
            "FromPort": "0",
            "IpProtocol": "-1",
            "ToPort": "65535"
          }
        ],
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Type": "AWS::EC2::SecurityGroup",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "1bd90a7c-409f-4ae2-a8ea-884184de0a15"
        }
      }
    },
    "Vpc": {
      "Properties": {
        "CidrBlock": {
          "Fn::FindInMap": ["VpcCidrs", "vpc", "cidr"]
        },
        "EnableDnsHostnames": "true",
        "EnableDnsSupport": "true",
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "VPC"
                ]
              ]
            }
          }
        ]
      },
      "Type": "AWS::EC2::VPC",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "0b630a3e-8b47-4876-bc52-7b0c367e0c8f"
        }
      }
    },
    "WebServerSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "GroupDescription": "Allow access from HTTP/HTTPS and SSH traffic",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "80",
            "ToPort": "80",
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "443",
            "ToPort": "443",
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": {
              "Ref": "SSHLocation"
            }
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "bc22286e-07bb-426e-8429-46c6227ec606"
        }
      }
    },
    "ManagerAsg": {
      "CreationPolicy": {
        "ResourceSignal": {
          "Count": {
            "Ref": "ManagerSize"
          },
          "Timeout": "PT20M"
        }
      },
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MaxBatchSize": "1",
          "MinInstancesInService": {
            "Ref": "ManagerSize"
          },
          "PauseTime": "PT20M",
          "WaitOnResourceSignals": "true"
        }
      },
      "Properties": {
        "AutoScalingGroupName": "Manager AutoScaling Group",
        "DesiredCapacity": {
          "Ref": "ManagerSize"
        },
        "LaunchTemplate": {
          "LaunchTemplateId": {
            "Ref": "ManagerLaunchTemplate"
          },
          "Version": {
            "Fn::GetAtt": ["ManagerLaunchTemplate", "LatestVersionNumber"]
          }
        },
        "TargetGroupARNs": [
          {
            "Ref": "ApplicationLoadBalancerTargetGroup"
          }
        ],
        "MinSize": 1,
        "MaxSize": 5,
        "Tags": [
          {
            "Key": "Name",
            "PropagateAtLaunch": true,
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "Manager"
                ]
              ]
            }
          },
          {
            "Key": "swarm-node-type",
            "PropagateAtLaunch": true,
            "Value": "manager"
          },
          {
            "Key": "swarm-stack-id",
            "PropagateAtLaunch": true,
            "Value": {
              "Ref": "AWS::StackId"
            }
          },
          {
            "Key": "DOCKER_VERSION",
            "PropagateAtLaunch": true,
            "Value": {
              "Fn::FindInMap": ["DockerEnvironment", "version", "docker"]
            }
          },
          {
            "Key": "ENVIRONMENT",
            "PropagateAtLaunch": true,
            "Value": "production"
          }
        ],
        "VPCZoneIdentifier": [
          {
            "Fn::If": [
              "HasOnly2AZs",
              {
                "Fn::Join": [
                  ",",
                  [
                    {
                      "Ref": "PubSubnetAz1"
                    },
                    {
                      "Ref": "PubSubnetAz2"
                    }
                  ]
                ]
              },
              {
                "Fn::Join": [
                  ",",
                  [
                    {
                      "Ref": "PubSubnetAz1"
                    },
                    {
                      "Ref": "PubSubnetAz2"
                    },
                    {
                      "Ref": "PubSubnetAz3"
                    }
                  ]
                ]
              }
            ]
          }
        ]
      },
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "28272b0f-5582-4714-81c8-5358e0f9e2b3"
        }
      }
    },
    "ManagerLaunchTemplate": {
      "DependsOn": "ApplicationLoadBalancer",
      "Type": "AWS::EC2::LaunchTemplate",
      "Properties": {
        "LaunchTemplateData": {
          "BlockDeviceMappings": [
            {
              "DeviceName": "/dev/sda1",
              "Ebs": {
                "Encrypted": "true",
                "VolumeSize": 8,
                "VolumeType": "gp2"
              }
            },
            {
              "DeviceName": "/dev/xvdb",
              "Ebs": {
                "Encrypted": "true",
                "VolumeSize": {
                  "Ref": "ManagerDiskSize"
                },
                "VolumeType": "gp2"
              }
            }
          ],
          "EbsOptimized": "false",
          "ImageId": {
            "Fn::FindInMap": [
              "AWSRegionArch2AMI",
              {
                "Ref": "AWS::Region"
              },
              {
                "Fn::FindInMap": [
                  "AWSInstanceType2Arch",
                  {
                    "Ref": "ManagerInstanceType"
                  },
                  "Arch"
                ]
              }
            ]
          },
          "InstanceType": {
            "Ref": "ManagerInstanceType"
          },
          "KeyName": {
            "Ref": "KeyName"
          },
          "NetworkInterfaces": [
            {
              "AssociatePublicIpAddress": "true",
              "DeleteOnTermination": "true",
              "DeviceIndex": 0,
              "Groups": [
                {
                  "Ref": "ManagerVpcSG"
                },
                {
                  "Ref": "SwarmWideSG"
                }
              ]
            }
          ],
          "UserData": {
            "Fn::Base64": {
              "Fn::Join": [
                "",
                [
                  "#!/bin/bash\n",
                  "apt-get update\n",
                  "apt-get -y install python-pip\n",
                  "pip install https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz\n",
                  "cfn-init -v -resource ManagerAsg",
                  " -stack ",
                  {
                    "Ref": "AWS::StackName"
                  },
                  " -region ",
                  {
                    "Ref": "AWS::Region"
                  },
                  "\n",
                  "echo 'unset HISTFILE' >> /home/ubuntu/.bashrc\n",
                  "echo 'export LESSHITFILE=\"-\"' >> /home/ubuntu/.bashrc\n",
                  "history -c\n",
                  "apt-get update\n",
                  "apt-get -y install apt-transport-https ca-certificates curl gnupg-agent software-properties-common\n",
                  "curl -L https: //gist.github.com/natac13/1669066880bd89489de27ed9a8b2e760/raw >> /home/ubuntu/.bash_aliases\n",
                  "source /home/ubuntu/.bashrc\n",
                  "curl -fsSL https: //download.docker.com/linux/ubuntu/gpg | apt-key add -\n",
                  "apt-key fingerprint 0EBFCD88\n",
                  "add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\"\n",
                  "apt-get update\n",
                  "apt-get install -y docker-ce docker-ce-cli containerd.io\n",
                  "groupadd docker\n",
                  "usermod -aG docker ubuntu\n",
                  "cfn-signal -e $? -resource ManagerAsg",
                  " -stack ",
                  {
                    "Ref": "AWS::StackName"
                  },
                  " -region ",
                  {
                    "Ref": "AWS::Region"
                  }
                ]
              ]
            }
          }
        },
        "LaunchTemplateName": "ManagerLaunchTemplate"
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "625bcd3e-aad4-4185-9d38-eaaa609b01f2"
        }
      }
    },
    "ApplicationLoadBalancerTargetGroup": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "HealthCheckIntervalSeconds": 60,
        "HealthCheckTimeoutSeconds": 5,
        "HealthyThresholdCount": 3,
        "Port": 80,
        "Protocol": "HTTP",
        "UnhealthyThresholdCount": 5,
        "VpcId": {
          "Ref": "Vpc"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "5ddc92d7-fa7c-41d4-a827-625da8863891"
        }
      }
    },
    "ApplicationLoadBalancerSG": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "GroupDescription": "Enable SSH access and HTTP access on the configured port",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": {
              "Ref": "SSHLocation"
            }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "80",
            "ToPort": "80",
            "CidrIp": "0.0.0.0/0"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "d780bac1-56c2-425e-a534-a3f55f40e397"
        }
      }
    },
    "ApplicationLoadBalancerListener": {
      "DependsOn": ["ApplicationLoadBalancer"],
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Properties": {
        "LoadBalancerArn": {
          "Ref": "ApplicationLoadBalancer"
        },
        "DefaultActions": [
          {
            "Type": "forward",
            "TargetGroupArn": {
              "Ref": "ApplicationLoadBalancerTargetGroup"
            }
          }
        ],
        "Port": "80",
        "Protocol": "HTTP"
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "117d008d-7b69-4c5c-9fbd-fc3893e18896"
        }
      }
    },
    "ApplicationLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "Type": "application",
        "SecurityGroups": [
          {
            "Ref": "ApplicationLoadBalancerSG"
          }
        ],
        "Subnets": {
          "Fn::If": [
            "HasOnly2AZs",
            [
              {
                "Ref": "PubSubnetAz1"
              },
              {
                "Ref": "PubSubnetAz2"
              }
            ],
            [
              {
                "Ref": "PubSubnetAz1"
              },
              {
                "Ref": "PubSubnetAz2"
              },
              {
                "Ref": "PubSubnetAz3"
              }
            ]
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "ELB"
                ]
              ]
            }
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "be37df0b-c7dd-47c1-8dcf-ff93660fe32f"
        }
      },
      "DependsOn": [
        "PubSubnetAz1",
        "PubSubnetAz3",
        "PubSubnetAz2",
        "ApplicationLoadBalancerSG",
        "AttachGateway"
      ]
    }
  }
}
